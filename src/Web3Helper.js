import Web3 from 'web3';

class Web3Helper {

  constructor() {

    this.FileManagerABI = [{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"uint256"}],"name":"files","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_ftype","type":"string"},{"name":"_hash","type":"string"},{"name":"_chunks","type":"string"},{"name":"_size","type":"uint256"},{"name":"_name","type":"string"},{"name":"_key","type":"string"},{"name":"_description","type":"string"}],"name":"addFile","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"file","type":"address"},{"indexed":false,"name":"uploader","type":"address"},{"indexed":false,"name":"name","type":"string"},{"indexed":false,"name":"description","type":"string"}],"name":"AddFile","type":"event"}];

    if (typeof window.web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
      this.web3js = new window.Web3(window.web3.currentProvider);
    } else {
      console.log('No web3? You should consider trying MetaMask!')
      // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
      this.web3js = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    this.public_address = this.web3js.eth.defaultAccount;

    this.FileManagerAddress = "0xf328562506f371c7f5465df925d1a8605bcee297";
  }

  waitForReceipt = function(hash, cb) {
    this.web3js.eth.getTransactionReceipt(hash, function (err, receipt) {
      if (err) { }
      if (receipt !== null) {
        if (cb) { cb(receipt); }
      } else { window.setTimeout(function () {
        this.waitForReceipt(hash, cb); }, 1000);
      }
    });
  }

  deployFile = function() {

    const bytecode = '0x60806040523480156200001157600080fd5b50604051620010b1380380620010b1833981018060405260408110156200003757600080fd5b8101908080516401000000008111156200005057600080fd5b828101905060208101848111156200006757600080fd5b81518560018202830111640100000000821117156200008557600080fd5b50509291906020018051640100000000811115620000a257600080fd5b82810190506020810184811115620000b957600080fd5b8151856001820283011164010000000082111715620000d757600080fd5b50509291905050508160029080519060200190620000f792919062000119565b5080600390805190602001906200011092919062000119565b505050620001c8565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200015c57805160ff19168380011785556200018d565b828001600101855582156200018d579182015b828111156200018c5782518255916020019190600101906200016f565b5b5090506200019c9190620001a0565b5090565b620001c591905b80821115620001c1576000816000905550600101620001a7565b5090565b90565b610ed980620001d86000396000f3fe6080604052600436106100b9576000357c01000000000000000000000000000000000000000000000000000000009004806395a078e81161008157806395a078e81461039e578063a3ffd0f014610407578063c124a90014610497578063c4a85bc1146104c6578063d2c0e0321461052f578063f088d547146106ae576100b9565b806312065fe0146100bb57806324c8c698146100e65780633bc5de301461017657806367709e2b146102a55780638823da6c14610335575b005b3480156100c757600080fd5b506100d06106f2565b6040518082815260200191505060405180910390f35b3480156100f257600080fd5b506100fb610711565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561013b578082015181840152602081019050610120565b50505050905090810190601f1680156101685780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561018257600080fd5b5061018b6107af565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200180602001838103835285818151815260200191508051906020019080838360005b838110156102015780820151818401526020810190506101e6565b50505050905090810190601f16801561022e5780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b8381101561026757808201518184015260208101905061024c565b50505050905090810190601f1680156102945780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b3480156102b157600080fd5b506102ba610975565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156102fa5780820151818401526020810190506102df565b50505050905090810190601f1680156103275780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561034157600080fd5b506103846004803603602081101561035857600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610a17565b604051808215151515815260200191505060405180910390f35b3480156103aa57600080fd5b506103ed600480360360208110156103c157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610b21565b604051808215151515815260200191505060405180910390f35b34801561041357600080fd5b5061041c610b41565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561045c578082015181840152602081019050610441565b50505050905090810190601f1680156104895780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156104a357600080fd5b506104ac610bdf565b604051808215151515815260200191505060405180910390f35b3480156104d257600080fd5b50610515600480360360208110156104e957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610c33565b604051808215151515815260200191505060405180910390f35b34801561053b57600080fd5b506106ac6004803603606081101561055257600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019064010000000081111561058f57600080fd5b8201836020820111156105a157600080fd5b803590602001918460018302840111640100000000831117156105c357600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561062657600080fd5b82018360208201111561063857600080fd5b8035906020019184600183028401116401000000008311171561065a57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610d3b565b005b6106f0600480360360208110156106c457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610dae565b005b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b60028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107a75780601f1061077c576101008083540402835291602001916107a7565b820191906000526020600020905b81548152906001019060200180831161078a57829003601f168201915b505050505081565b6000606080600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151561080c57600080fd5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660026003818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108c75780601f1061089c576101008083540402835291602001916108c7565b820191906000526020600020905b8154815290600101906020018083116108aa57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109635780601f1061093857610100808354040283529160200191610963565b820191906000526020600020905b81548152906001019060200180831161094657829003601f168201915b50505050509050925092509250909192565b606060028054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a0d5780601f106109e257610100808354040283529160200191610a0d565b820191906000526020600020905b8154815290600101906020018083116109f057829003601f168201915b5050505050905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610a7457600080fd5b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16159050919050565b60016020528060005260406000206000915054906101000a900460ff1681565b60038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bd75780601f10610bac57610100808354040283529160200191610bd7565b820191906000526020600020905b815481529060010190602001808311610bba57829003601f168201915b505050505081565b6000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610c9057600080fd5b60018060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff169050919050565b826000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508160029080519060200190610d91929190610e08565b508060039080519060200190610da8929190610e08565b50505050565b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610e4957805160ff1916838001178555610e77565b82800160010185558215610e77579182015b82811115610e76578251825591602001919060010190610e5b565b5b509050610e849190610e88565b5090565b610eaa91905b80821115610ea6576000816000905550600101610e8e565b5090565b9056fea165627a7a72305820b9b392d856e68322e657c9ff29e54c887c4f654920d8ba59998d623350bee8f10029';

    this.web3js

    let MyContract = web3.eth.contract(abi['file']);
    const myContract = new web3.eth.Contract(['Rama','Nick'], {
      from: this.public_address,
      gasPrice: '20000000000',
      data: bytecode
    });


  };

  addedFile = function(data) {
    console.log("Added data");
    var self = this;
    var file_obj = data;
    return new Promise((resolve, reject) => {

    console.log(file_obj);

    var FMC = self.web3js.eth.contract(self.FileManagerABI);
    var FileManager = FMC.at(self.FileManagerAddress);
    console.log(self.FileManagerAddress);
    console.log(self.public_address);
    console.log(FileManager);

    FileManager.addFile(
      file_obj["type"],
      file_obj["hash"],
      file_obj["chunks"][0],
      file_obj["size"],
      "The Study Guide to the MCAT 2018",
      file_obj["key"],
      "The Medical College Admission TestÂ® (MCAT), developed and administered by the AAMC, is a standardized, multiple-choice examination created to help medical school admissions offices assess your problem solving, critical thinking, and knowledge of natural, behavioral, and social science concepts and principles.",
    { from: self.public_address }, (err, txHash) => {
        console.log(err);
        resolve(txHash);
    });


    });
  }



}

export default Web3Helper;
